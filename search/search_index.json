{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Overview","text":"<p>Documentation for the backend system for the tinymotion General Movements Assessment data collection app.</p> <p>TinyMotion Backend is written in Python and exposes an API (built using FastAPI) and also has a command line interface for administering the backend.</p> <p>The backend is currently under development and likely to change.</p>"},{"location":"api/","title":"API Reference","text":"<p>This page provides documentation for the application programming interface.</p> <p></p>"},{"location":"architecture/","title":"Architecture","text":""},{"location":"architecture/#overview","title":"Overview","text":"<p>The backend is written in Python using:</p> <ul> <li>the FastAPI framework</li> <li>Pydantic and SQLAlchemy (via SQLModel)</li> <li>click for the command line interface</li> <li>SQLite database</li> <li>pytest for testing</li> <li>mkdocs for documentation</li> </ul> <p>Deployment is achieved using Terraform and Ansible to create and configure a VM on an OpenStack cloud (NeSI RDC). The TinyMotion backend software is containerised using docker and run using Docker compose. SWAG (secure web access gateway) is used in front of the API and handles generating SSL certificates.</p>"},{"location":"architecture/#api","title":"API","text":"<p>The API provides endpoints to authenticate, create an infant, create a consent and upload a video. There are no endpoints to retrieve information in the initial version of the API.</p> <p>An infant must be created first. Once an infant has been created a consent must be created for that infant. The consent is linked to the infant by NHI number. Once a consent has been created, videos can be created for the infant. Videos are linked to an infant by NHI number. The API will return errors in the following cases (not exclusive, see also API docs TODO):</p> <ul> <li>a consent is added with an NHI number that does not match an infant in the database</li> <li>a video is added with an NHI number that does not match an infant in the database</li> <li>a video is added for an infant that has no consent recorded in the database</li> </ul>"},{"location":"architecture/#authentication","title":"Authentication","text":"<p>An access key is created for each user and shared with them. The access key is entered into the app and an API endpoint called to exchange the access key for access and refresh JWT tokens. The access token is passed in the Authorization header with subsequent API requests. If the access token expires, the refresh token can be used to generate a new access token. If the refresh token expires the access key must be entered again.</p> <p>Initially, all users of the app will be treated the same (authorisation). All users will be able to upload (POST) information via the API. There are no API endpoints to retrieve information.</p> <p>Note</p> <p>This approach to authentication was chosen as a compromise between security and ease of use for the early access users of the app.</p>"},{"location":"architecture/#administration","title":"Administration","text":"<p>Administration (e.g. creating/updating users, accessing videos and information in the database) is done through SSH and a command line interface. SSH to the VM is by public key only.</p>"},{"location":"architecture/#database","title":"Database","text":"<p>The initial version uses an SQLite database with the following structure:</p> <pre><code>erDiagram\n    USER {\n        UUID user_id PK\n        string email \"Must be unique; encrypted\"\n        string access_key \"Must be unique; encrypted\"\n        boolean disabled\n    }\n\n    INFANT {\n        UUID infant_id PK\n        string nhi_number \"Must be unique; encrypted\"\n        string full_name \"Encrypted\"\n        date birth_date \"Encrypted\"\n        date due_date \"Encrypted\"\n        datetime created_at\n        UUID created_by FK\n    }\n\n    CONSENT {\n        UUID consent_id PK\n        string consent_giver_name \"Can be null if consent collected physically; encrypted\"\n        string consent_giver_email \"Can be null if consent collected physically; encrypted\"\n        boolean collected_physically\n        UUID infant_id FK\n        datetime created_at\n        UUID created_by FK\n    }\n\n    VIDEO {\n        UUID video_id PK\n        UUID infant_id FK\n        string video_name \"Name of stored video, a randomly generated UUID\"\n        int video_size \"Size of the encrypted video in bytes\"\n        string sha256sum \"SHA-256 checksum of the original video\"\n        string sha256sum_enc \"SHA-256 checksum of the encrypted video\"\n        datetime created_at\n        UUID created_by FK\n    }\n\n    INFANT ||--o{ CONSENT : \"is covered by\"\n    INFANT ||--o{ VIDEO : \"features in\"\n    USER ||--o{ CONSENT : creates\n    USER ||--o{ VIDEO : creates\n    USER ||--o{ INFANT : creates\n\n</code></pre> <p>Fields marked as encrypted are encrypted at rest using <code>StringEncryptedType</code> (symmetric encryption) from SQLAlchemy-Utils.</p> <p>Database backups can be achieved by copying the SQLite database file. Encrypted information in the backups will not be understandable without the secret key that was used to encrypt them.</p> <p>Note</p> <p>SQLite should be sufficient while running at a small scale, and is good for speed of development, but could be worth considering switching to another database engine, such as PostgreSQL, when scaling up. This should be relatively simple as the database engine is abstracted away by SQLAlchemy.</p>"},{"location":"architecture/#video-files","title":"Video files","text":"<p>Video files are encrypted as they are received and written to disk on the VM in encrypted form only. Videos are encrypted using Fernet (symmetric encryption, i.e. requiring the same secret key to decrypt them as was used to encrypt them). Encrypted video files are approximately 1/3 bigger than the unencrypted version would be. Video file names on disk are randomly generated UUIDs, these names are stored as video_name in the VIDEO table in the database.</p> <p>[NOT IMPLEMENTED YET] Encrypted video files will be stored on object storage. Once they have been pushed to object storage they will be removed from VM disk.</p> <p>Note</p> <p>If upload of a video file fails part way through the upload you have to start again from scratch. This may not work well, especially in areas with slow/poor connection. If this becomes an issue we may want to consider implementing resumable file upload, for example tus.</p>"},{"location":"architecture/#secrets-management","title":"Secrets management","text":"<p>TODO</p>"},{"location":"reference/cli/","title":"CLI Reference","text":"<p>This page provides reference documentation for the command line interface.</p>"},{"location":"reference/cli/#tinymotion-backend","title":"tinymotion-backend","text":"<p>Command line interface to TinyMotion Backend</p> <p>Usage:</p> <pre><code>tinymotion-backend [OPTIONS] COMMAND [ARGS]...\n</code></pre> <p>Options:</p> Name Type Description Default <code>--help</code> boolean Show this message and exit. <code>False</code> <p>Subcommands</p> <ul> <li>consent: Commands to interact with consents in the backend.</li> <li>infant: Commands to interact with infants in the backend.</li> <li>user: Commands to interact with users in the backend.</li> <li>version: Print the version of the TinyMotion backend and exit.</li> <li>video: Commands to interact with videos in the backend.</li> </ul>"},{"location":"reference/cli/#tinymotion-backend-consent","title":"tinymotion-backend consent","text":"<p>Commands to interact with consents in the backend.</p> <p>Usage:</p> <pre><code>tinymotion-backend consent [OPTIONS] COMMAND [ARGS]...\n</code></pre> <p>Options:</p> Name Type Description Default <code>--help</code> boolean Show this message and exit. <code>False</code> <p>Subcommands</p> <ul> <li>create: Create a new consent.</li> <li>list: List existing consents.</li> </ul>"},{"location":"reference/cli/#tinymotion-backend-consent-create","title":"tinymotion-backend consent create","text":"<p>Create a new consent.</p> <p>Usage:</p> <pre><code>tinymotion-backend consent create [OPTIONS]\n</code></pre> <p>Options:</p> Name Type Description Default <code>-u</code>, <code>--user-id</code> uuid ID of the User to create the Consent _required <code>-i</code>, <code>--infant-id</code> uuid The infant_id of the infant this Consent relates to _required <code>-n</code>, <code>--consent-giver-name</code> text The Consent giver's name None <code>-e</code>, <code>--consent-giver-email</code> text The Consent giver's email None <code>-p</code>, <code>--collected-physically</code> boolean Flag to indicate if the Consent was collected physically <code>False</code> <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-consent-list","title":"tinymotion-backend consent list","text":"<p>List existing consents.</p> <p>Usage:</p> <pre><code>tinymotion-backend consent list [OPTIONS]\n</code></pre> <p>Options:</p> Name Type Description Default <code>-p</code>, <code>--pager</code> boolean Display results using a pager <code>False</code> <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-infant","title":"tinymotion-backend infant","text":"<p>Commands to interact with infants in the backend.</p> <p>Usage:</p> <pre><code>tinymotion-backend infant [OPTIONS] COMMAND [ARGS]...\n</code></pre> <p>Options:</p> Name Type Description Default <code>--help</code> boolean Show this message and exit. <code>False</code> <p>Subcommands</p> <ul> <li>create: Create a new infant.</li> <li>delete: Delete the specified Infant.</li> <li>list: List existing infants.</li> <li>update: Update the specified Infant.</li> </ul>"},{"location":"reference/cli/#tinymotion-backend-infant-create","title":"tinymotion-backend infant create","text":"<p>Create a new infant.</p> <p>Usage:</p> <pre><code>tinymotion-backend infant create [OPTIONS]\n</code></pre> <p>Options:</p> Name Type Description Default <code>-u</code>, <code>--user-id</code> uuid ID of the User to create the Infant _required <code>-f</code>, <code>--full-name</code> text The infant's full name _required <code>-n</code>, <code>--nhi-number</code> text The infant's NHI number _required <code>-b</code>, <code>--birth-date</code> datetime (<code>%Y-%m-%d</code>) The infant's date of birth _required <code>-d</code>, <code>--due-date</code> datetime (<code>%Y-%m-%d</code>) The infant's expected date of birth _required <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-infant-delete","title":"tinymotion-backend infant delete","text":"<p>Delete the specified Infant.</p> <p>INFANT_ID is the id of the infant to delete.</p> <p>Usage:</p> <pre><code>tinymotion-backend infant delete [OPTIONS] INFANT_ID\n</code></pre> <p>Options:</p> Name Type Description Default <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-infant-list","title":"tinymotion-backend infant list","text":"<p>List existing infants.</p> <p>Usage:</p> <pre><code>tinymotion-backend infant list [OPTIONS]\n</code></pre> <p>Options:</p> Name Type Description Default <code>-p</code>, <code>--pager</code> boolean Display results using a pager <code>False</code> <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-infant-update","title":"tinymotion-backend infant update","text":"<p>Update the specified Infant.</p> <p>INFANT_ID is the id of the infant to update.</p> <p>Usage:</p> <pre><code>tinymotion-backend infant update [OPTIONS] INFANT_ID\n</code></pre> <p>Options:</p> Name Type Description Default <code>-f</code>, <code>--full-name</code> text The infant's full name None <code>-n</code>, <code>--nhi-number</code> text The infant's NHI number None <code>-b</code>, <code>--birth-date</code> datetime (<code>%Y-%m-%d</code>) The infant's date of birth None <code>-d</code>, <code>--due-date</code> datetime (<code>%Y-%m-%d</code>) The infant's expected date of birth None <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-user","title":"tinymotion-backend user","text":"<p>Commands to interact with users in the backend.</p> <p>Usage:</p> <pre><code>tinymotion-backend user [OPTIONS] COMMAND [ARGS]...\n</code></pre> <p>Options:</p> Name Type Description Default <code>--help</code> boolean Show this message and exit. <code>False</code> <p>Subcommands</p> <ul> <li>create: Create a new user.</li> <li>delete: Delete the specified User.</li> <li>list: List existing users.</li> <li>update: Update the specified User.</li> </ul>"},{"location":"reference/cli/#tinymotion-backend-user-create","title":"tinymotion-backend user create","text":"<p>Create a new user.</p> <p>Usage:</p> <pre><code>tinymotion-backend user create [OPTIONS]\n</code></pre> <p>Options:</p> Name Type Description Default <code>-e</code>, <code>--email</code> text The new user's email _required <code>-k</code>, <code>--access-key</code> text The new user's access key that they will use to login _required <code>-d</code>, <code>--disabled</code> boolean Disable the user's account on creation <code>False</code> <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-user-delete","title":"tinymotion-backend user delete","text":"<p>Delete the specified User.</p> <p>USER_ID is the id of the user to delete.</p> <p>Usage:</p> <pre><code>tinymotion-backend user delete [OPTIONS] USER_ID\n</code></pre> <p>Options:</p> Name Type Description Default <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-user-list","title":"tinymotion-backend user list","text":"<p>List existing users.</p> <p>Usage:</p> <pre><code>tinymotion-backend user list [OPTIONS]\n</code></pre> <p>Options:</p> Name Type Description Default <code>-p</code>, <code>--pager</code> boolean Display results using a pager <code>False</code> <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-user-update","title":"tinymotion-backend user update","text":"<p>Update the specified User.</p> <p>USER_ID is the id of the user to update.</p> <p>Usage:</p> <pre><code>tinymotion-backend user update [OPTIONS] USER_ID\n</code></pre> <p>Options:</p> Name Type Description Default <code>-e</code>, <code>--email</code> text Update the user's email None <code>-k</code>, <code>--access-key</code> text Update the user's access key None <code>-d</code>, <code>--disabled</code> boolean Update whether the user is disabled None <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-version","title":"tinymotion-backend version","text":"<p>Print the version of the TinyMotion backend and exit.</p> <p>Usage:</p> <pre><code>tinymotion-backend version [OPTIONS]\n</code></pre> <p>Options:</p> Name Type Description Default <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-video","title":"tinymotion-backend video","text":"<p>Commands to interact with videos in the backend.</p> <p>Usage:</p> <pre><code>tinymotion-backend video [OPTIONS] COMMAND [ARGS]...\n</code></pre> <p>Options:</p> Name Type Description Default <code>--help</code> boolean Show this message and exit. <code>False</code> <p>Subcommands</p> <ul> <li>delete: Delete the specified video and the associated record in the database.</li> <li>list: List stored videos.</li> </ul>"},{"location":"reference/cli/#tinymotion-backend-video-delete","title":"tinymotion-backend video delete","text":"<p>Delete the specified video and the associated record in the database.</p> <p>VIDEO_ID is the id of the video to delete.</p> <p>Usage:</p> <pre><code>tinymotion-backend video delete [OPTIONS] VIDEO_ID\n</code></pre> <p>Options:</p> Name Type Description Default <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"reference/cli/#tinymotion-backend-video-list","title":"tinymotion-backend video list","text":"<p>List stored videos.</p> <p>Usage:</p> <pre><code>tinymotion-backend video list [OPTIONS]\n</code></pre> <p>Options:</p> Name Type Description Default <code>-p</code>, <code>--pager</code> boolean Display results using a pager <code>False</code> <code>--help</code> boolean Show this message and exit. <code>False</code>"},{"location":"tutorials/creating-users-via-cli/","title":"Creating users via the command line interface","text":"<p>Full command line interface (CLI) reference can be found here.</p>"},{"location":"tutorials/creating-users-via-cli/#prerequisites","title":"Prerequisites","text":"<p>You will need to be able to SSH into the VM running the backend (TODO: move to a separate page).</p> <p>Usually the person who deployed the VM will have SSH access to the VM. In order for other people to access the VM they will need to create an SSH key pair and share the public key with the person who created the VM, who will then have to add that key to the authorized_keys file on the VM.</p> <p>An SSH keypair could be generated using</p> <pre><code>ssh-keygen\n</code></pre> <p>Check the options for that command so that you know what you are doing. You may already have one in your ~/.ssh directory. The file ending in .pub is the public key that should be shared, the one with no extension is private and should not be shared but will be used to connect to the VM, e.g. with a command like:</p> <pre><code>ssh -i ~/.ssh/&lt;private-key-file&gt; &lt;username&gt;@&lt;backend-domain-name&gt;\n</code></pre>"},{"location":"tutorials/creating-users-via-cli/#cli-basics","title":"CLI basics","text":"<p>On the VM, you should be able to use the CLI with the command <code>tinymotion-backend</code>, for example you could print the version of the backend using:</p> <pre><code>tinymotion-backend version\n</code></pre> <p>Print the list of available commands using:</p> <pre><code>tinymotion-backend --help\n</code></pre> <p>This should show a number of commands, one of which will be <code>user</code>.</p> <p>List the available sub-commands for the <code>user</code> command:</p> <pre><code>tinymotion-backend user --help\n</code></pre> <p>You should be able to see a number of <code>user</code> sub-commands, including <code>create</code>, <code>delete</code>, <code>update</code> and <code>list</code>.</p> <p>You can run the sub-command with the <code>--help</code> option to view usage information for each of the sub-commands too, e.g.</p> <pre><code>tinymotion-backend user create --help\n</code></pre>"},{"location":"tutorials/creating-users-via-cli/#list-existing-users","title":"List existing users","text":"<p>To list existing users run:</p> <pre><code>tinymotion-backend user list\n</code></pre> <p>This should give output in JSON format, which could look something like:</p> <p><pre><code>[\n  {\n    \"access_key\": \"mysecretaccesskey\",\n    \"user_id\": \"bca7af43-6fc8-456b-b59b-389aeeae3dc4\",\n    \"disabled\": false,\n    \"email\": \"testuser1@example.com\"\n  },\n  {\n    \"access_key\": \"anothersecretkey\",\n    \"user_id\": \"3203a857-7f11-44b8-96b6-c319ea437d4e\",\n    \"disabled\": false,\n    \"email\": \"testuser2@example.com\"\n  }\n]\n</code></pre> if there were two users in the system.</p>"},{"location":"tutorials/creating-users-via-cli/#create-a-new-user","title":"Create a new user","text":"<p>Let's create a new user with the command:</p> <pre><code>tinymotion-backend user create -e myuser@example.com -k myuseraccesskey\n</code></pre> <p>You can see from the output of <code>tinymotion-backend user create --help</code> that the <code>-e</code> option sets the email of the new user and <code>-k</code> the access key.</p> <p>If successful, the above command will output the new user in JSON format, e.g.</p> <pre><code>{\n  \"access_key\": \"myuseraccesskey\",\n  \"user_id\": \"cbae11b5-1bd0-4686-8784-e1dafd952126\",\n  \"disabled\": false,\n  \"email\": \"myuser@example.com\"\n}\n</code></pre> <p>Note the <code>user_id</code> will be a randomly generated UUID so will be different to the one above but will have the same format.</p>"},{"location":"tutorials/creating-users-via-cli/#list-users-again","title":"List users again","text":"<p>Verify that your new user shows up now when you run:</p> <pre><code>tinymotion-backend user list\n</code></pre> <p>This should show the new user you just created along with any pre-existing users (if any), e.g.</p> <pre><code>[\n  {\n    \"access_key\": \"mysecretaccesskey\",\n    \"user_id\": \"bca7af43-6fc8-456b-b59b-389aeeae3dc4\",\n    \"disabled\": false,\n    \"email\": \"testuser1@example.com\"\n  },\n  {\n    \"access_key\": \"anothersecretkey\",\n    \"user_id\": \"3203a857-7f11-44b8-96b6-c319ea437d4e\",\n    \"disabled\": false,\n    \"email\": \"testuser2@example.com\"\n  },\n  {\n    \"access_key\": \"myuseraccesskey\",\n    \"user_id\": \"cbae11b5-1bd0-4686-8784-e1dafd952126\",\n    \"disabled\": false,\n    \"email\": \"myuser@example.com\"\n  }\n]\n</code></pre>"},{"location":"tutorials/creating-users-via-cli/#modifying-a-users-access-key","title":"Modifying a user's access key","text":"<p>Let's try changing the access key of the user we just created, using the <code>user update</code> command.</p> <p>First run <code>tinymotion-backend user update --help</code> to see the available options.</p> <p>Using the example new user above, we could run:</p> <pre><code>tinymotion-backend user update -k updatedaccesskey cbae11b5-1bd0-4686-8784-e1dafd952126\n</code></pre> <p>Note that we have to pass the <code>user_id</code> as an argument to the above function. You will need to use the correct <code>user_id</code> for the user that you just created.</p> <p>If successful the above command should output the updated user record in JSON format, e.g.</p> <pre><code>{\n  \"access_key\": \"updatedaccesskey\",\n  \"user_id\": \"cbae11b5-1bd0-4686-8784-e1dafd952126\",\n  \"disabled\": false,\n  \"email\": \"myuser@example.com\"\n}\n</code></pre>"},{"location":"tutorials/deploy-backend/","title":"Deploy backend","text":"<p>This tutorial will show how to deploy the backend.</p>"}]}